# 订单定价函数式服务说明

## 服务概述

订单定价函数式服务（`functionService`）基于 Spring Cloud Function 构建，提供一个纯函数 `orderLineTotal`，用于按书籍单价与数量计算订单行小计，并可通过 API Gateway 为电子书系统的其他模块（如后端订单接口、前端结算页）提供统一的定价能力。

- **输入**：`unitPrice`（书籍单价，单位元）、`quantity`（购买数量）
- **输出**：`totalPrice`（该书籍在订单中的总价，保留 2 位小数）

函数部署后通过 HTTP POST 请求 `/orderLineTotal` 调用，借助 API Gateway 对外暴露为 `/api/order-pricing`。

## 无状态的含义

函数式服务遵循“输入 → 输出”的纯函数模型：

- **不依赖外部会话或数据库**：同样的输入永远返回同样的输出，不记录用户或订单上下文信息。
- **不修改外部状态**：函数只计算结果，不写入数据库、缓存，也不维护内存变量。

这种无状态特性意味着函数实例之间没有共享状态，扩缩容时无需同步数据，也不存在因状态不一致导致的结果偏差。

## 易扩展的原因

- **水平伸缩简单**：任意数量的函数实例都能独立处理请求，流量增加时只需增加实例或容器副本。
- **启动快、资源占用低**：函数服务只聚焦数值计算，启动和运行时开销极低。
- **易组合与复用**：函数可作为基础能力被后端服务、Gateway 或其他函数串联调用，便于构建复杂的业务流程。

## 部署步骤

1. **启动 Eureka 注册中心（端口 8761）**
   ```bash
   cd microservices/eureka-server
   mvn spring-boot:run
   ```

2. **启动函数式服务（端口 8090）**
   ```bash
   cd microservices/order-pricing-service
   mvn spring-boot:run
   ```
   - 服务启动后会自动向 Eureka 注册（服务名 `functionService`），函数 `orderLineTotal` 通过 `POST /orderLineTotal` 提供计算能力。

3. **启动 API Gateway（端口 8085）**
   ```bash
   cd microservices/api-gateway
   mvn spring-boot:run
   ```
   - 网关路由配置：
     ```yaml
     spring:
       cloud:
         gateway:
           routes:
             - id: function-service
               uri: lb://functionService
               predicates:
                 - Path=/api/function-service/**
               filters:
                 - StripPrefix=2
                 - PrefixPath=/orderLineTotal
     ```
   - 外部调用示例：
     ```
     POST http://localhost:8085/api/function-service
     {
       "unitPrice": 68.00,
       "quantity": 3
     }
     =>
     { "totalPrice": 204.00 }
     ```

## 在 E-Book 系统中的使用方式

1. **后端整合**
   - 在 `backend` 模块中新增 `OrderPricingClient`，通过 Gateway 地址 `http://localhost:8085/api/function-service` 调用函数服务。
   - `OrderController` 在返回订单详情时为每个订单项补充 `lineTotal` 字段，并汇总得到 `orderTotal`，供前端直接展示。

2. **前端展示**
   - `src/views/orders.jsx` 读取后端返回的 `lineTotal`、`orderTotal`，渲染“商品小计”和“订单总金额”。
   - 若函数服务暂不可用，会退回到本地计算逻辑，保障结果一致。

3. **故障处理**
   - `OrderPricingClient` 若调用失败，会记录日志并回退到 `单价 × 数量` 的计算方式，确保订单流程不中断。
   - 可结合 Gateway 的熔断、限流策略和函数服务自身的健康检查（`/actuator/health`）提升可用性。

通过该函数式服务，订单定价逻辑实现了高度模块化与可扩展，满足“按需扩缩、易复用、便于维护”的微服务化目标。

