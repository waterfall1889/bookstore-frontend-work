# 作者查询微服务说明

## 概述

为满足电子书商城在书籍详情和搜索页面中按书名获取作者信息的需求，本项目新增了 **作者查询微服务**。该服务暴露 REST API，输入书名后返回作者列表，并通过服务注册中心（Eureka）注册，由 API Gateway 统一路由转发，从而实现微服务间的解耦与高可用。

核心组件：

- **作者查询微服务（Author Lookup Service）**：负责根据书名检索作者信息，通常查询关系型数据库或缓存。
- **服务注册中心（Eureka Server）**：维护各微服务的实例信息，提供服务发现能力。
- **API Gateway**：统一外部入口，基于服务注册中心进行动态路由与限流、鉴权等横切能力。

## 架构角色说明

- **Service Registry（Eureka Server）作用**
  - 提供集中式服务发现：作者查询服务启动后会将自身实例信息（服务名、IP、端口、健康状况）注册到 Eureka。
  - 实例健康监测：Eureka 定期接收心跳，失联实例会被剔除，避免网关转发到不可用节点。
  - 支持水平扩展：当作者查询服务扩容时，新实例会自动注册，消费方无需修改配置即可感知。

- **Gateway 作用**
  - **统一入口**：前端只需访问网关暴露的 `/api/author-lookup/**`，无需了解后端服务拓扑。
  - **动态路由**：网关根据服务名向 Eureka 查询可用实例，并以负载均衡策略转发请求。
  - **安全与治理**：可在网关添加鉴权、限流、熔断、日志等策略，降低业务服务复杂度。
  - **协议适配**：网关可处理跨域、协议转换等需求，让业务服务专注于核心逻辑。

## 微服务实现与配置示例

1. **服务主类**
   - 包路径示例：`org.example.author.AuthorLookupApplication`
   - 关键注解：`@SpringBootApplication`、`@EnableDiscoveryClient`

2. **REST 控制器**
   - 端点：`GET /api/v1/authors?bookName=...`
   - 功能：根据书名模糊查询作者信息，返回结构如下的 JSON：
     ```json
     {
       "query": "三体",
       "total": 1,
       "results": [
         { "itemId": "000000001", "bookName": "三体", "authors": ["刘慈欣"] }
       ]
     }
     ```

3. **配置文件 `application.yml`**
   ```yaml
   server:
     port: 8082
   spring:
     application:
       name: author-lookup-service
     datasource:
       url: jdbc:mysql://localhost:3306/bookstore?useSSL=false&serverTimezone=UTC
       username: root
       password: 20050829zzm
       driver-class-name: com.mysql.cj.jdbc.Driver
     jpa:
       hibernate:
         ddl-auto: none
       properties:
         hibernate.dialect: org.hibernate.dialect.MySQLDialect
   eureka:
     client:
       serviceUrl:
         defaultZone: http://localhost:8761/eureka/
   ```

4. **数据访问层**
   - 使用 Spring Data JPA 直接查询 `item_meta` 表，调用方式与后端 `ItemRepository`/`ItemDao` 一致：先精确匹配 `findByItemNameAndValidness`，未命中时再做模糊搜索并仅返回 `validness = 1` 的有效图书。

## 部署步骤

1. **准备环境**
   - 安装 JDK 17+
   - 安装 Maven（示例命令使用 `mvn`）
   - 确认本地或线上已部署 `bookstore` 数据库，并在 `item_meta` 表中维护书籍及作者数据

2. **启动服务注册中心**
   ```bash
   cd microservices/eureka-server
   mvn spring-boot:run  # Windows 可改用 mvn.cmd
   ```

3. **启动作者查询微服务**
   ```bash
   cd microservices/author-lookup-service
   mvn clean package
   java -jar target/author-lookup-service-0.0.1-SNAPSHOT.jar
   ```
- 开发阶段可直接运行 `mvn spring-boot:run`。
   - 若需外部配置，可通过 `--spring.config.additional-location` 指定不同环境的配置文件。

4. **启动 API Gateway**
   ```bash
   cd microservices/api-gateway
   mvn spring-boot:run
   ```
   - 在网关的 `application.yml` 中，为作者查询服务配置路由（端口默认为 `8085`）。项目内的 `GatewayCorsConfiguration` 会允许前端 `http://localhost:3000` 发起跨域请求：
     ```yaml
     spring:
       cloud:
        gateway:
          routes:
             - id: author-lookup
               uri: lb://author-lookup-service
               predicates:
                 - Path=/api/author-lookup/**
               filters:
                - StripPrefix=2
                - PrefixPath=/api
     ```

5. **验证**
   - 打开 `http://localhost:8761`，确认 `author-lookup-service` 已注册。
   - 访问 `http://localhost:8085/api/author-lookup/v1/authors?bookName=三体` 检查返回结果。

## 在电子书系统中的使用方式

1. **前端调用**
   - 在前端新增 `src/service/authorLookupService.jsx`，通过 Gateway（端口 `8085`）统一入口请求 `GET /api/author-lookup/v1/authors?bookName=<keyword>`。
   - 主页侧栏新增 “微服务体验 → 作者查询” 菜单项（`Sidebar` 组件），跳转到 `src/views/author_lookup.jsx` 页面。用户可在该页面输入书名，实时展示来自微服务的作者结果。

2. **后端现有模块对接**
   - 若后端 `backend` 模块需调用，可使用 `RestTemplate`、`WebClient` 或 Feign，通过服务名 `author-lookup-service` 直接访问，避免固定 IP。

3. **故障处理**
   - 建议在 Gateway 配置熔断器（Resilience4J / Spring Cloud CircuitBreaker），并在前端展示兜底提示。
   - 配合 Eureka 的自我保护机制，避免网络波动导致误判下线。

## 运维与扩展

- **日志与监控**：建议统一输出结构化日志，并接入 Prometheus + Grafana 或 Spring Boot Admin 监控服务健康。
- **扩容策略**：在业务高峰期，复制部署多个作者查询实例；Eureka 自动更新实例列表，Gateway 负责负载均衡。
- **版本升级**：使用蓝绿或滚动发布，在 Gateway 层做版本路由，确保平滑迁移。

通过以上实践，作者查询微服务获得了独立部署、易扩展、易治理的优势，同时 Gateway 与 Service Registry 的组合保障了服务发现与流量调度的高可用性。

