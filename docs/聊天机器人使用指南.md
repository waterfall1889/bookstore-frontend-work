# 聊天机器人使用指南

## 概述

本系统集成了基于DeepSeek API的聊天机器人，可以帮助用户搜索和查询图书信息。聊天机器人通过集成MCP书籍查询工具，能够智能地回答用户关于图书的问题。

## 系统架构

1. **Python Flask聊天服务** (`chatbot-service/chatbot_agent.py`)
   - 基于Flask的HTTP服务
   - 集成DeepSeek API
   - 集成MCP书籍查询工具

2. **Spring Boot后端代理** (`backend/.../ChatbotController.java`)
   - 提供API代理接口
   - 处理跨域问题
   - 转发请求到Python服务

3. **React前端组件** (`src/views/chatbot.jsx`)
   - 聊天界面
   - 消息展示
   - 用户交互

## 安装步骤

### 1. 安装Python依赖

```bash
cd chatbot-service
pip install -r requirements.txt
```

依赖包包括：
- flask>=2.3.0
- flask-cors>=4.0.0
- requests>=2.31.0
- mysql-connector-python>=8.0.33

### 2. 配置数据库连接（可选）

如果数据库配置与默认不同，可以通过环境变量配置：

**Windows (PowerShell):**
```powershell
$env:DB_HOST="localhost"
$env:DB_PORT="3306"
$env:DB_NAME="bookstore"
$env:DB_USER="root"
$env:DB_PASSWORD="your_password"
```

**Linux/Mac:**
```bash
export DB_HOST=localhost
export DB_PORT=3306
export DB_NAME=bookstore
export DB_USER=root
export DB_PASSWORD=your_password
```

### 3. 启动聊天服务

**Windows:**
```bash
cd chatbot-service
python chatbot_agent.py
# 或双击 start_chatbot.bat
```

**Linux/Mac:**
```bash
cd chatbot-service
python3 chatbot_agent.py
# 或
chmod +x start_chatbot.sh
./start_chatbot.sh
```

服务将在 `http://localhost:5000` 启动。

### 4. 启动Spring Boot后端

确保Spring Boot后端正在运行在 `http://localhost:8080`。

### 5. 启动React前端

```bash
npm start
```

前端将在 `http://localhost:3000` 启动。

## 使用说明

### 访问聊天界面

1. 启动所有服务后，在浏览器中访问 `http://localhost:3000`
2. 登录系统
3. 在导航栏中访问 `/chatbot` 路径，或直接访问 `http://localhost:3000/chatbot`

### 聊天功能

聊天机器人支持以下功能：

1. **搜索图书**
   - 可以询问："帮我找一本Java相关的书籍"
   - 可以询问："搜索Python编程的图书"
   - 支持书名、作者、ISBN、出版社的模糊搜索

2. **查询特定图书**
   - 可以询问："告诉我ID为B001的图书详细信息"
   - 可以提供图书ID查询详细信息

3. **按作者查询**
   - 可以询问："查找作者张三的所有图书"
   - 可以询问："XXX作者写了哪些书"

4. **普通对话**
   - 可以与机器人进行一般性对话
   - 机器人会友好地回答用户的问题

### API接口

#### POST /api/chatbot/chat

发送聊天消息。

**请求体：**
```json
{
  "message": "帮我找一本Java相关的书籍",
  "history": [
    {
      "role": "user",
      "content": "你好"
    },
    {
      "role": "assistant",
      "content": "您好！我是书店助手，有什么可以帮您的吗？"
    }
  ]
}
```

**响应：**
```json
{
  "response": "我为您找到了以下Java相关书籍：...",
  "success": true
}
```

#### GET /api/chatbot/health

检查聊天服务健康状态。

**响应：**
```json
{
  "status": "healthy",
  "chatbot_service": "available"
}
```

## 故障排查

### 1. 聊天服务无法启动

**问题：** Python服务启动失败

**解决方案：**
- 检查Python版本（需要Python 3.8+）
- 确认所有依赖已安装：`pip install -r requirements.txt`
- 检查端口5000是否被占用
- 查看错误日志

### 2. 无法连接到聊天服务

**问题：** 前端提示"聊天服务暂时不可用"

**解决方案：**
- 确认Python聊天服务正在运行
- 检查服务是否监听在 `http://localhost:5000`
- 检查防火墙设置
- 查看浏览器控制台和服务器日志

### 3. 数据库连接错误

**问题：** 工具调用时提示数据库错误

**解决方案：**
- 确认MySQL服务正在运行
- 检查数据库连接配置（环境变量或代码中的DB_CONFIG）
- 确认数据库`bookstore`存在
- 确认表`item_meta`存在且有数据

### 4. DeepSeek API调用失败

**问题：** API调用错误

**解决方案：**
- 检查API密钥是否正确
- 确认网络连接正常
- 检查API配额是否用完
- 查看服务器日志获取详细错误信息

### 5. 跨域问题

**问题：** 浏览器控制台显示CORS错误

**解决方案：**
- Spring Boot后端已配置`@CrossOrigin(origins = "*")`
- Python服务已配置`CORS(app)`
- 如果仍有问题，检查代理配置

## 技术细节

### DeepSeek API集成

- **API URL:** `https://api.deepseek.com/v1/chat/completions`
- **模型:** `deepseek-chat`
- **工具调用:** 支持Function Calling
- **温度:** 0.7
- **最大Token:** 2000

### MCP工具集成

聊天机器人集成了以下MCP工具：

1. **search_books** - 搜索图书
   - 参数: query (必需), limit (可选，默认10)
   - 支持模糊搜索书名、作者、ISBN、出版社

2. **get_book_by_id** - 根据ID查询图书
   - 参数: item_id (必需)
   - 返回图书详细信息

3. **get_books_by_author** - 按作者查询
   - 参数: author (必需), limit (可选，默认20)
   - 返回该作者的所有图书

### 消息流程

1. 用户在前端输入消息
2. React组件调用Spring Boot API (`/api/chatbot/chat`)
3. Spring Boot转发请求到Python服务 (`http://localhost:5000/chat`)
4. Python服务调用DeepSeek API
5. 如果模型决定使用工具，执行工具调用（查询数据库）
6. 将工具结果返回给模型
7. 模型生成最终回复
8. 回复通过Spring Boot返回给前端
9. 前端展示回复

## 开发说明

### 添加新的工具

1. 在`chatbot_agent.py`中实现工具函数
2. 在`get_tools_definition()`中添加工具定义
3. 在`execute_tool_call()`中添加工具调用逻辑

### 自定义系统提示

修改`chatbot_agent.py`中的`system_prompt`变量来自定义AI助手的行为。

### 修改API配置

修改`chatbot_agent.py`中的`DEEPSEEK_API_KEY`和`DEEPSEEK_API_URL`来使用不同的API。

## 注意事项

1. **API密钥安全**: 当前API密钥硬编码在代码中，生产环境应使用环境变量或配置文件
2. **数据库连接**: 确保数据库连接安全，不要在生产环境使用弱密码
3. **服务端口**: 确保端口5000和8080未被占用
4. **错误处理**: 系统包含基本的错误处理，但可以进一步完善
5. **性能优化**: 对话历史限制为最近10条消息，避免token过多

## 许可证

本项目为BookStore系统的一部分。
