# 图书标签系统使用说明

## 功能概述

本系统实现了基于Neo4J图数据库的图书标签分类系统，支持：
1. 为图书添加标签分类
2. 在Neo4J中构建标签关系图（树形结构）
3. 基于标签的智能搜索（包括相关标签）

## 系统架构

### 数据库设计

#### MySQL表结构
1. **book_tags** - 标签表
   - tag_id: 标签ID（主键）
   - tag_name: 标签名称（唯一）
   - description: 标签描述

2. **book_tag_relations** - 图书-标签关联表
   - id: 主键
   - item_id: 图书ID（外键关联item_meta表）
   - tag_id: 标签ID（外键关联book_tags表）

#### Neo4J图结构
- **节点类型**: Tag
- **关系类型**: SUBCATEGORY_OF（表示子分类关系）
- **关系方向**: 子标签 -> 父标签（例如：Science Fiction -> Fiction）

### 标签关系示例

```
Fiction
├── Science Fiction
├── Fantasy
├── Mystery
├── Romance
├── Thriller
└── Horror

Non-Fiction
├── Biography
├── History
├── Science
│   ├── Technology
│   │   └── Programming
│   └── Mathematics
├── Business
└── Education
```

## 安装和配置

### 1. 数据库初始化

执行SQL脚本创建标签表：
```sql
-- 执行 backend/src/main/resources/tags_schema.sql
```

### 2. Neo4J配置

在 `application.properties` 中配置Neo4J连接：
```properties
spring.neo4j.uri=bolt://localhost:7687
spring.neo4j.authentication.username=neo4j
spring.neo4j.authentication.password=20050829zzm
# 指定Neo4j数据库名称（在bookTags实例下的booktag数据库）
spring.neo4j.database=booktag
```

**重要说明**：
- 系统会将标签数据存储到Neo4J实例 `bookTags` 下的 `booktag` 数据库
- 确保在Neo4J中已创建 `booktag` 数据库
- 如果数据库不存在，Neo4J会自动创建（取决于Neo4J版本和配置）

### 3. 初始化标签关系图

系统启动时会自动初始化标签关系图，也可以手动调用API：
```bash
POST http://localhost:8080/api/tags/init-graph
```

## API接口

### 1. 标签搜索

#### 按单个标签搜索
```http
POST /api/books/searchByTag
Content-Type: application/json

{
  "tagName": "Science Fiction"
}
```

#### 按多个标签搜索
```http
POST /api/books/searchByTags
Content-Type: application/json

{
  "tagNames": ["Science Fiction", "Fantasy"]
}
```

### 2. 获取所有标签
```http
GET /api/tags
```

### 3. 获取图书的标签
```http
GET /api/books/{bookId}/tags
```

### 4. 初始化标签关系图
```http
POST /api/tags/init-graph
```

### 5. 同步MySQL标签到Neo4J
```http
POST /api/tags/sync-to-neo4j
```

## 搜索逻辑

当用户按标签搜索时，系统会：

1. **从Neo4J查找相关标签**
   - 找到用户选中的标签
   - 通过最多2次边连接，找到所有相关标签
   - 包括父标签、子标签、兄弟标签等

2. **在MySQL中搜索图书**
   - 使用找到的所有相关标签
   - 搜索所有带有这些标签中任意一个或多个的图书
   - 只返回有效图书（validness = 1）

### 示例

如果用户搜索 "Science Fiction"：
- Neo4J会找到：Science Fiction, Fiction, Technology, Programming 等相关标签
- MySQL会返回所有带有这些标签的图书

## 前端使用

在图书列表页面（`/books`），用户可以：
1. 看到所有可用标签
2. 点击标签进行搜索
3. 查看已选标签
4. 清除标签筛选

## 为图书添加标签

### 通过代码添加
```java
@Autowired
private BookTagService bookTagService;

// 为图书添加单个标签
bookTagService.addTagToBook("B001", "Science Fiction");

// 为图书添加多个标签
bookTagService.addTagsToBook("B001", Arrays.asList("Science Fiction", "Technology"));
```

### 通过数据库添加
```sql
-- 首先确保标签存在
INSERT INTO book_tags (tag_name, description) 
VALUES ('Science Fiction', '科幻小说')
ON DUPLICATE KEY UPDATE tag_name=tag_name;

-- 为图书添加标签
INSERT INTO book_tag_relations (item_id, tag_id)
SELECT 'B001', tag_id FROM book_tags WHERE tag_name = 'Science Fiction';
```

## 注意事项

1. **Neo4J必须运行**：标签搜索功能依赖Neo4J，确保Neo4J服务正在运行
2. **标签同步**：MySQL中的标签需要同步到Neo4J才能建立关系图
3. **关系方向**：子标签指向父标签（SUBCATEGORY_OF关系）
4. **搜索范围**：最多通过2次边连接查找相关标签

## 故障排查

### Neo4J连接失败
- 检查Neo4J服务是否运行
- 验证连接配置（URI、用户名、密码）
- 查看应用日志中的错误信息

### 搜索无结果
- 确认图书已添加标签
- 检查标签名称是否正确
- 验证Neo4J中是否存在标签关系

### 标签关系未建立
- 调用 `/api/tags/init-graph` 初始化关系图
- 手动创建标签关系（通过Neo4jTagService）

