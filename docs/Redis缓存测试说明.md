# Redis缓存测试说明文档

## 一、系统设计说明

### 1.1 缓存架构设计

系统实现了图书基础信息和库存信息的分离缓存：

- **图书基础信息缓存**（`book:info:{itemId}`）：
  - 包含：itemName, author, price, coverUrl, isbn, publish, validness
  - TTL：3600秒（1小时）
  - 使用Hash结构存储

- **图书库存缓存**（`book:stock:{itemId}`）：
  - 包含：remainNumber（库存数量）
  - TTL：1800秒（30分钟）
  - 使用String结构存储，便于原子操作

### 1.2 缓存策略

- **读操作**（Cache-Aside模式）：
  1. 先从Redis缓存读取
  2. 如果缓存未命中，从数据库读取
  3. 将数据写入缓存（异步）

- **写操作**（Write-Through模式）：
  1. 先写入数据库
  2. 同时更新缓存（同步）
  3. 删除相关列表缓存

### 1.3 降级策略

当Redis不可用时：
- 所有缓存操作会捕获异常
- 自动降级到数据库查询
- 系统继续正常运行
- 在日志中记录Redis不可用的警告信息

## 二、测试场景

### 2.1 首次读写测试

**步骤**：
1. 启动Redis服务器
2. 启动应用程序
3. 查询一个从未查询过的图书（例如：`GET /api/books/{bookId}`）
4. 观察日志输出

**预期结果**：
- 日志显示："缓存未命中，从数据库查询图书"
- 日志显示："从数据库查询图书成功，写入缓存"
- 日志显示："写入图书基础信息到缓存成功"
- 日志显示："写入图书库存到缓存成功"

### 2.2 后续读写测试（缓存命中）

**步骤**：
1. 再次查询同一个图书ID（在TTL时间内）
2. 观察日志输出

**预期结果**：
- 日志显示："从缓存读取图书基础信息成功"
- 日志显示："从缓存读取图书库存成功"
- 日志显示："从缓存构建完整图书信息成功"
- 日志显示："从缓存获取图书成功"
- **不会**出现数据库查询日志

### 2.3 库存更新测试

**步骤**：
1. 创建一个订单（会减少库存）
2. 观察日志输出

**预期结果**：
- 日志显示："更新库存 - itemId: xxx, 旧库存: xxx, 减少: xxx, 新库存: xxx"
- 日志显示："库存缓存更新完成"
- 日志显示："更新图书库存成功 - itemId: xxx, delta: -xxx"

### 2.4 Redis宕机测试

**步骤**：
1. 确保系统正在运行，并且已经有一些缓存数据
2. 关闭Redis服务器（在Redis运行窗口中按Ctrl+C，或者关闭Redis进程）
3. 尝试查询图书信息
4. 尝试创建订单
5. 观察日志输出

**预期结果**：
- 日志显示："Redis不可用: Connection refused" 或类似错误
- 日志显示："Redis不可用，跳过缓存读取"
- 日志显示："缓存未命中，从数据库查询图书"（降级到数据库）
- 系统继续正常运行，所有功能正常
- 不会因为Redis宕机而导致系统崩溃

### 2.5 Redis恢复测试

**步骤**：
1. 在Redis宕机的情况下，查询一些图书（数据会从数据库读取）
2. 重新启动Redis服务器
3. 再次查询相同的图书

**预期结果**：
- Redis恢复后，查询会先写入缓存
- 后续查询会从缓存读取

## 三、日志输出说明

### 3.1 日志级别

- **INFO**：正常的缓存操作（读取、写入、更新）
- **DEBUG**：详细的缓存操作信息（命中、未命中）
- **WARN**：Redis不可用警告（系统会降级）
- **ERROR**：Redis操作异常（不影响系统运行）

### 3.2 关键日志关键字

- `从缓存读取`：表示缓存命中
- `缓存未命中`：表示缓存未命中，需要查询数据库
- `Redis不可用`：表示Redis连接失败，系统降级
- `写入缓存`：表示数据写入缓存成功
- `更新图书库存`：表示库存更新操作

## 四、测试步骤

### 4.1 启动Redis

**Windows方式**：
```cmd
cd C:\Redis
redis-server.exe
```

**验证Redis运行**：
```cmd
redis-cli.exe
> ping
PONG
```

### 4.2 启动应用程序

启动Spring Boot应用，观察启动日志，确认：
- Redis配置加载成功
- 没有Redis连接错误

### 4.3 执行测试

按照上述测试场景逐一测试，并截图保存日志输出。

## 五、注意事项

1. **首次启动**：如果Redis未启动，应用会启动失败（因为配置了Redis依赖）。可以修改配置，使Redis为可选。

2. **缓存一致性**：库存更新时，系统会同时更新数据库和缓存，确保一致性。

3. **TTL设置**：缓存设置了过期时间，过期的缓存会自动清理。

4. **降级策略**：当Redis不可用时，系统会自动降级到数据库，不影响功能。

## 六、截图清单

测试时需要截图的场景：

1. ✅ **首次查询图书**（缓存未命中）
   - 显示从数据库查询
   - 显示写入缓存成功

2. ✅ **再次查询相同图书**（缓存命中）
   - 显示从缓存读取
   - 不显示数据库查询

3. ✅ **创建订单**（库存更新）
   - 显示库存更新日志
   - 显示缓存更新日志

4. ✅ **Redis宕机后查询**
   - 显示Redis不可用警告
   - 显示降级到数据库查询
   - 显示系统正常运行

5. ✅ **Redis恢复后查询**
   - 显示重新写入缓存
   - 显示后续缓存命中

